{% extends 'trafik_app/base.html' %} {% block title %}Trafik Tahmini - Avcılar
Trafik Tahmin Sistemi{% endblock %} {% block extra_css %}
<link rel="stylesheet" href="/static/css/custom.css" />
{% endblock %} {% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="mb-4">Trafik Tahmini</h1>
    <p class="lead">
      Belirli bir konum, tarih ve saat için trafik tahminleri yapın. Haritadan
      bir konum seçin veya koordinatları girin.
    </p>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">Konum Seçin</div>
      <div class="card-body p-0">
        <div class="map-container">
          <div id="tahminHaritasi" style="height: 500px"></div>
        </div>
      </div>
      <div class="card-footer text-muted">
        Haritada bir konuma tıklayarak seçim yapabilirsiniz.
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">Tahmin Bilgileri</div>
      <div class="card-body">
        <form action="{% url 'sonuc' %}" method="post">
          {% csrf_token %}
          <!-- Form hata mesajları -->
          {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
          {% endif %}

          <!-- Gizli konum alanı -->
          <input type="hidden" id="konum" name="konum" value="41.003,28.705" />

          <!-- Tarih alanı -->
          <div class="mb-3">
            <label for="id_tarih" class="form-label">Tarih</label>
            <input
              type="date"
              class="form-control"
              id="id_tarih"
              name="tarih"
              value="{% now 'Y-m-d' %}"
              required
            />
            <div class="form-text">Trafik tahmini yapılacak tarih</div>
          </div>

          <!-- Saat alanı -->
          <div class="mb-3">
            <label for="id_saat" class="form-label">Seyahat Saati</label>
            <input
              type="time"
              class="form-control"
              id="id_saat"
              name="saat"
              value="08:00"
              required
            />
            <div class="form-text">Trafik tahmini yapılacak saat</div>
          </div>

          <!-- Konum gösterge alanları (kullanıcı için bilgi amaçlı) -->
          <div class="mb-3">
            <label for="lat" class="form-label">Enlem</label>
            <input
              type="number"
              step="0.000001"
              class="form-control"
              id="lat"
              value="41.003"
              readonly
            />
          </div>
          <div class="mb-3">
            <label for="lng" class="form-label">Boylam</label>
            <input
              type="number"
              step="0.000001"
              class="form-control"
              id="lng"
              value="28.705"
              readonly
            />
          </div>

          <!-- Mesafe alanı -->
          <div class="mb-3">
            <label for="id_mesafe" class="form-label">Mesafe (km)</label>
            <input
              type="number"
              step="0.1"
              class="form-control"
              id="id_mesafe"
              name="mesafe"
              value="5.0"
              min="0.1"
              max="50.0"
              required
            />
            <div class="form-text">
              Seyahat etmek istediğiniz tahmini mesafe
            </div>
          </div>

          <button type="submit" class="btn btn-primary w-100">
            Tahmin Yap
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="/static/js/map_utils.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Tahmin sayfası yüklendi, harita başlatılıyor...");

    // Varsayılan konum (Avcılar)
    var defaultLat = 41.003;
    var defaultLng = 28.705;

    // Form alanları
    var latInput = document.getElementById("lat");
    var lngInput = document.getElementById("lng");
    var konumInput = document.getElementById("konum");

    // Form değerlerini al (varsayılan değerleri kullan)
    var initialLat = latInput ? parseFloat(latInput.value) : defaultLat;
    var initialLng = lngInput ? parseFloat(lngInput.value) : defaultLng;

    // Geçersiz değerleri kontrol et
    if (isNaN(initialLat) || isNaN(initialLng)) {
      initialLat = defaultLat;
      initialLng = defaultLng;
    }

    // Harita ve işaretleyici için global değişkenler
    var tahminHaritasi;
    var marker;

    // Haritayı başlat
    setTimeout(function () {
      try {
        // Konum haritasını özel işaretleyici olmadan başlat
        tahminHaritasi = L.map("tahminHaritasi").setView(
          [initialLat, initialLng],
          14
        );
        console.log("Harita oluşturuldu, merkez:", initialLat, initialLng);

        // Harita katmanı ekle
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(tahminHaritasi);

        // Konum bilgisi oluştur (virgülden sonra 6 basamak)
        var latFormatted = parseFloat(initialLat.toFixed(6));
        var lngFormatted = parseFloat(initialLng.toFixed(6));
        var locationText =
          "Seçilen Konum: " + latFormatted + ", " + lngFormatted;

        // İşaretleyici ekle
        marker = L.marker([initialLat, initialLng]).addTo(tahminHaritasi);
        marker.bindPopup(locationText).openPopup();

        // Harita tıklama işlevi
        tahminHaritasi.on("click", function (e) {
          var lat = e.latlng.lat;
          var lng = e.latlng.lng;

          // Konum bilgisini 6 basamaklı olarak göster
          var latFormatted = parseFloat(lat.toFixed(6));
          var lngFormatted = parseFloat(lng.toFixed(6));
          var locationText =
            "Seçilen Konum: " + latFormatted + ", " + lngFormatted;

          // İşaretleyiciyi güncelle
          marker.setLatLng([lat, lng]);
          marker.bindPopup(locationText).openPopup();

          // Form alanlarını güncelle (tam değerlerle)
          latInput.value = latFormatted;
          lngInput.value = lngFormatted;

          // Gizli konum alanını güncelle (Django form için)
          konumInput.value = latFormatted + "," + lngFormatted;

          console.log("Konum seçildi:", latFormatted, lngFormatted);
        });

        // Harita yeniden boyutlandırma
        window.addEventListener("resize", function () {
          resizeMap(tahminHaritasi);
        });
      } catch (error) {
        console.error("Harita oluşturma hatası:", error);
        document.getElementById("tahminHaritasi").innerHTML =
          '<div class="alert alert-danger m-3">Harita yüklenirken bir hata oluştu. Lütfen sayfayı yenileyin.</div>';
      }
    }, 500);
  });
</script>
{% endblock %}
